# Top Gene Pairs with Metadata Correlation Analysis Tool

A command-line tool for combining top gene pairs across tissues and automatically computing fresh correlations with GTEx metadata for comprehensive gene pair analysis.

## Overview

This tool processes the output files generated by `report_top_gene_pairs.py`, combines them across tissues for each combination category, and then **automatically computes fresh metadata correlations** for every gene pair using the `metadata_corr_cli.py` tool. This provides comprehensive metadata context for top-performing gene pairs across tissues.

### Key Features

- **Automatic Metadata Correlation**: Computes fresh correlations with GTEx metadata for every gene pair
- **Multi-Combination Processing**: Processes all 5 combination categories automatically  
- **Cross-Tissue Aggregation**: Combines results from 54+ GTEx tissues per combination
- **Top Metadata Extraction**: Identifies top-N metadata variables for each gene individually and commonly
- **Comprehensive Enhancement**: Adds 30+ metadata correlation columns per gene pair
- **Flexible Top-N Selection**: Configurable number of top gene pairs and metadata correlations
- **Tissue Annotation**: Adds tissue column to track origin of each gene pair
- **Multiple Output Formats**: Results in both pickle (.pkl) and CSV formats
- **Robust Processing**: Handles CLI failures gracefully with detailed progress tracking
- **Discovery Commands**: List available tissues and combinations

## Requirements

### Dependencies

```python
pandas
numpy
subprocess (standard library)
tempfile (standard library)
```

### Required External Tools

- **`metadata_corr_cli.py`**: Located at `nbs/03-manuscript/05-metadata_correlation/metadata_corr_cli.py`
- **GTEx Expression Data**: Available at `/pividori_lab/haoyu_projects/ccc-gpu/data/gtex/gene_selection/all`

### Input Data Structure

```
{data_dir}/
├── {tissue1}/
│   ├── c-high-p-high-s-low/
│   │   └── top_{N}_gene_pairs.csv
│   ├── c-high-p-low-s-high/
│   │   └── top_{N}_gene_pairs.csv
│   ├── c-high-p-low-s-low/
│   │   └── top_{N}_gene_pairs.csv
│   ├── c-high-p-low-s-none/
│   │   └── top_{N}_gene_pairs.csv
│   └── c-high-p-none-s-low/
│       └── top_{N}_gene_pairs.csv
├── {tissue2}/
│   └── ... (same structure)
└── ...
```

## Installation

```bash
# Navigate to the script directory
cd nbs/03-manuscript/30_explore_gene_pairs

# Make executable (if needed)
chmod +x 10-correlate-top-genes-with-metadata.py
```

## Usage

### Basic Usage

```bash
# Process top 1000 gene pairs with metadata correlations (recommended for testing)
python 10-correlate-top-genes-with-metadata.py --top 1000

# Process top 10000 gene pairs (computationally intensive - takes hours)
python 10-correlate-top-genes-with-metadata.py --top 10000

# Custom output directory and top-5 metadata per gene
python 10-correlate-top-genes-with-metadata.py --top 1000 --output-dir ./custom_output --top-metadata-correlations 5
```

### Discovery Commands

```bash
# List all available combination categories
python 10-correlate-top-genes-with-metadata.py --list-combinations

# List all available tissues  
python 10-correlate-top-genes-with-metadata.py --list-tissues
```

### Advanced Usage

```bash
# Custom data directory and top-10 metadata correlations
python 10-correlate-top-genes-with-metadata.py \
    --top 5000 \
    --data-dir /path/to/gene_pair_selection \
    --output-dir /path/to/output \
    --top-metadata-correlations 10
```

## Command Line Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `--top` | int | Required* | Number of top gene pairs to match (e.g., 1000 for top_1000_gene_pairs.csv) |
| `--data-dir` | str | `/pividori_lab/haoyu_projects/ccc-gpu/results/gene_pair_selection` | Directory containing gene pair selection results |
| `--output-dir` | str | `/pividori_lab/haoyu_projects/ccc-gpu/results/top_gene_pair_correlation` | Directory to save combined results |
| `--top-metadata-correlations` | int | 5 | Number of top metadata correlations to extract for each gene |
| `--list-combinations` | flag | False | List available combination categories and exit |
| `--list-tissues` | flag | False | List available tissues and exit |

*Not required for `--list-*` commands

## Metadata Correlation Processing

### Automatic Enhancement

**Every gene pair** in the combined datasets is automatically processed to:

1. **Call metadata_corr_cli.py** with the gene pair symbols
2. **Extract correlation results** from temporary output files
3. **Identify top-N metadata variables** for each gene individually
4. **Find common top metadata variables** between gene pairs
5. **Add 30+ new columns** with correlation values and p-values

### Output Columns Added

For each gene pair, the following columns are added:

#### Gene 1 Metadata (5 columns per metadata variable, default N=5)
- `gene1_top1_metadata` through `gene1_top5_metadata`
- `gene1_top1_ccc` through `gene1_top5_ccc`  
- `gene1_top1_pval` through `gene1_top5_pval`

#### Gene 2 Metadata (5 columns per metadata variable, default N=5)
- `gene2_top1_metadata` through `gene2_top5_metadata`
- `gene2_top1_ccc` through `gene2_top5_ccc`
- `gene2_top1_pval` through `gene2_top5_pval`

#### Common Metadata (N columns, default N=5)
- `common_top1_metadata` through `common_top5_metadata`
- `common_top1_score` through `common_top5_score`

### CLI Call Details

Each gene pair triggers:
```bash
python metadata_corr_cli.py \
    --gene1 {gene1_symbol} \
    --gene2 {gene2_symbol} \
    --expr-data-dir /pividori_lab/haoyu_projects/ccc-gpu/data/gtex/gene_selection/all \
    --output {temp_file}
```

## Combination Categories

The tool processes these 5 combination categories:

1. **c-high-p-high-s-low**: High CCC, High Pearson, Low Spearman
2. **c-high-p-low-s-high**: High CCC, Low Pearson, High Spearman  
3. **c-high-p-low-s-low**: High CCC, Low Pearson, Low Spearman
4. **c-high-p-low-s-none**: High CCC, Low Pearson, No Spearman constraint
5. **c-high-p-none-s-low**: High CCC, No Pearson constraint, Low Spearman

## Output Files

### Enhanced Combined Results

For each combination category, the tool generates:

- **Enhanced Pickle**: `combined_{combination}_top_gene_pairs_with_metadata.pkl`
- **Enhanced CSV**: `combined_{combination}_top_gene_pairs_with_metadata.csv`

### File Contents

Each combined file contains:
- **Original columns**: All data from input CSV files
- **tissue**: Added column indicating source tissue
- **Metadata columns**: 30+ new columns with correlation data per gene pair

### Summary Files
- **Summary Report**: `combination_summary_report.txt`
- **Log File**: `logs/gene_pair_combination_{timestamp}/gene_pair_combination.log`

### Example Output Files
```
combined_c-high-p-high-s-low_top_gene_pairs_with_metadata.pkl
combined_c-high-p-high-s-low_top_gene_pairs_with_metadata.csv
combined_c-high-p-low-s-high_top_gene_pairs_with_metadata.pkl  
combined_c-high-p-low-s-high_top_gene_pairs_with_metadata.csv
combined_c-high-p-low-s-low_top_gene_pairs_with_metadata.pkl
combined_c-high-p-low-s-low_top_gene_pairs_with_metadata.csv
combined_c-high-p-low-s-none_top_gene_pairs_with_metadata.pkl
combined_c-high-p-low-s-none_top_gene_pairs_with_metadata.csv
combined_c-high-p-none-s-low_top_gene_pairs_with_metadata.pkl
combined_c-high-p-none-s-low_top_gene_pairs_with_metadata.csv
```

## Processing Workflow

### 1. **Discovery Phase**
- Scans data directory for available tissues
- Identifies all combination categories
- Maps file availability across tissue-combination pairs

### 2. **Data Combination**  
- For each combination category:
  - Loads CSV files from all available tissues
  - Adds tissue annotation column
  - Combines into unified dataframe

### 3. **Metadata Enhancement**
- **For each gene pair in the combined dataframe:**
  - Calls `metadata_corr_cli.py` with gene symbols
  - Parses correlation results from temporary files
  - Extracts top-N metadata for each gene individually
  - Identifies common top metadata between genes
  - Adds correlation values and p-values as new columns

### 4. **Output Generation**
- Saves enhanced dataframes in pickle and CSV formats
- Creates comprehensive summary reports
- Documents processing statistics and runtime

## Performance Characteristics

### ⚠️ Computational Requirements

**This tool is computationally intensive** due to fresh metadata correlation computation for every gene pair.

### Expected Processing Time

- **top 100**: ~5-10 minutes
- **top 1000**: ~1-3 hours  
- **top 10000**: ~10-30 hours
- **Time scales approximately linearly with number of gene pairs**

### CLI Call Statistics (Example with --top 1000)
```
Total gene pairs processed: ~50,000-270,000 (depending on combinations)
CLI calls per gene pair: 1
Expected CLI calls: ~50,000-270,000
Success rate: ~95-99%
Failed gene pairs: Logged and filled with NaN values
```

### Memory Requirements
- **RAM**: ~4-16 GB depending on dataset size
- **Temporary storage**: ~10-50 GB for correlation results
- **Final storage**: Combined files 200-800 MB per combination

### Resource Recommendations
- **CPU**: Multiple cores beneficial (CLI calls can benefit from system caching)
- **Storage**: SSD recommended for temporary file I/O
- **Network**: Stable connection if using networked storage

## Data Validation & Error Handling

### CLI Processing Statistics
- **Successful correlations**: Logged with percentage success rate
- **Failed CLI calls**: Logged as warnings, filled with NaN values  
- **Timeout handling**: CLI calls have reasonable timeout limits
- **Temporary file cleanup**: Automatic cleanup of correlation result files

### Quality Control
- **Missing data**: NaN values for failed correlations
- **Data integrity**: Validation of correlation result parsing
- **Progress tracking**: Detailed logging of processing status

## Troubleshooting

### Common Issues

1. **Very slow processing**
   - **Expected**: Processing is inherently slow due to CLI calls
   - **Solution**: Start with smaller `--top` values (100-1000) for testing
   - **Optimization**: Run on high-performance computing resources

2. **metadata_corr_cli.py not found**
   - **Check**: Verify script exists at expected path
   - **Solution**: Update hardcoded path in the script if needed

3. **Expression data directory not found**  
   - **Check**: Verify GTEx data path exists: `/pividori_lab/haoyu_projects/ccc-gpu/data/gtex/gene_selection/all`
   - **Solution**: Update path in metadata_corr_cli.py if data moved

4. **High CLI failure rate**
   - **Cause**: Gene symbols not found in expression data
   - **Expected**: Some failures are normal (5-10%)
   - **Impact**: Failed pairs filled with NaN, processing continues

5. **Out of disk space**
   - **Cause**: Temporary correlation files accumulate
   - **Solution**: Ensure sufficient temp space, monitor disk usage
   - **Prevention**: Regular cleanup of temp directories

### Performance Optimization

1. **Start Small**: Test with `--top 100` before larger datasets
2. **Monitor Resources**: Watch CPU, memory, and disk usage  
3. **Batch Processing**: Consider processing combinations separately
4. **Storage**: Use fast SSD for temporary files if possible

## Output Interpretation

### Enhanced DataFrames

Each row represents a gene pair with:
- **Original data**: All columns from input gene pair files
- **tissue**: Source tissue for the gene pair
- **Gene metadata**: Top-N metadata variables correlated with each gene
- **Correlation values**: CCC values for gene-metadata correlations
- **P-values**: Statistical significance of correlations
- **Common metadata**: Metadata variables significant for both genes

### Analysis Applications

The enhanced datasets enable:
- **Functional annotation**: Understanding what biological processes/tissues correlate with gene pairs
- **Mechanistic insights**: Identifying shared regulatory contexts
- **Biomarker discovery**: Finding metadata patterns associated with strong gene correlations
- **Cross-tissue comparison**: Comparing metadata associations across tissues

## Integration with Downstream Analysis

### Usage in Research Workflows
```
report_top_gene_pairs.py → top_{N}_gene_pairs.csv files
                       ↓
10-correlate-top-genes-with-metadata.py → enhanced datasets with metadata
                                        ↓
                          Biological interpretation & analysis
```

### Complementary Tools
- **Pathway analysis**: Use enhanced metadata for functional enrichment
- **Visualization**: Plot metadata associations for gene pairs
- **Statistical modeling**: Incorporate metadata as covariates

## Version Information

- **Script**: 10-correlate-top-genes-with-metadata.py  
- **Purpose**: Combine gene pairs and enhance with fresh metadata correlations
- **Input source**: report_top_gene_pairs.py results
- **Output format**: Metadata-enhanced tissue-annotated combined datasets
- **Processing mode**: Always computes fresh correlations (no pre-computed option)

## Support

For issues related to:
- **Performance**: Start with smaller datasets and monitor resources
- **CLI failures**: Check metadata_corr_cli.py and expression data paths
- **Missing data**: Review processing logs for error patterns  
- **File formats**: Verify input CSV structure and gene symbol availability 