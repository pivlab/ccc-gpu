# Top Gene Pairs Combination Analysis Tool

A command-line tool for combining top gene pairs across tissues and combination categories from the `report_top_gene_pairs.py` analysis results.

## Overview

This tool processes the output files generated by `nbs/03-manuscript/30_explore_gene_pairs/report_top_gene_pairs.py` and combines them across all tissues for each combination category. It creates unified datasets that aggregate top gene pairs from multiple tissues, enabling cross-tissue comparative analysis.

### Key Features

- **Multi-Combination Processing**: Processes all 5 combination categories automatically
- **Cross-Tissue Aggregation**: Combines results from 54+ GTEx tissues per combination
- **Flexible Top-N Selection**: Configurable number of top gene pairs to process
- **Tissue Annotation**: Adds tissue column to track origin of each gene pair
- **Multiple Output Formats**: Results in both pickle (.pkl) and CSV formats
- **Comprehensive Logging**: Detailed progress tracking and error reporting
- **Discovery Commands**: List available tissues and combinations
- **Robust Error Handling**: Graceful handling of missing files and data issues

## Requirements

### Dependencies

```python
pandas
numpy
```

### Input Data Structure

The tool expects data organized as:
```
{data_dir}/
├── {tissue1}/
│   ├── c-high-p-high-s-low/
│   │   └── top_{N}_gene_pairs.csv
│   ├── c-high-p-low-s-high/
│   │   └── top_{N}_gene_pairs.csv
│   ├── c-high-p-low-s-low/
│   │   └── top_{N}_gene_pairs.csv
│   ├── c-high-p-low-s-none/
│   │   └── top_{N}_gene_pairs.csv
│   └── c-high-p-none-s-low/
│       └── top_{N}_gene_pairs.csv
├── {tissue2}/
│   └── ... (same structure)
└── ...
```

## Installation

```bash
# Navigate to the script directory
cd nbs/03-manuscript/05-metadata_correlation

# Make executable (if needed)
chmod +x 10-correlate-top-genes-with-metadata.py
```

## Usage

### Basic Usage

```bash
# Process top 10000 gene pairs across all tissues and combinations
python 10-correlate-top-genes-with-metadata.py --top 10000

# Process top 1000 gene pairs with custom output directory
python 10-correlate-top-genes-with-metadata.py --top 1000 --output-dir ./custom_output
```

### Discovery Commands

```bash
# List all available combination categories
python 10-correlate-top-genes-with-metadata.py --list-combinations

# List all available tissues
python 10-correlate-top-genes-with-metadata.py --list-tissues
```

### Advanced Usage

```bash
# Custom data directory and output location
python 10-correlate-top-genes-with-metadata.py \
    --top 5000 \
    --data-dir /path/to/gene_pair_selection \
    --output-dir /path/to/output

# Process specific top-N value that matches existing files
python 10-correlate-top-genes-with-metadata.py --top 1000
```

## Command Line Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `--top` | int | Required* | Number of top gene pairs to match (e.g., 1000 for top_1000_gene_pairs.csv) |
| `--data-dir` | str | `/pividori_lab/haoyu_projects/ccc-gpu/results/gene_pair_selection` | Directory containing gene pair selection results |
| `--output-dir` | str | `/pividori_lab/haoyu_projects/ccc-gpu/results/top_gene_pair_correlation` | Directory to save combined results |
| `--list-combinations` | flag | False | List available combination categories and exit |
| `--list-tissues` | flag | False | List available tissues and exit |

*Not required for `--list-*` commands

## Combination Categories

The tool processes these 5 combination categories:

1. **c-high-p-high-s-low**: High CCC, High Pearson, Low Spearman
2. **c-high-p-low-s-high**: High CCC, Low Pearson, High Spearman  
3. **c-high-p-low-s-low**: High CCC, Low Pearson, Low Spearman
4. **c-high-p-low-s-none**: High CCC, Low Pearson, No Spearman constraint
5. **c-high-p-none-s-low**: High CCC, No Pearson constraint, Low Spearman

## Input File Format

### Expected CSV Structure
Each `top_{N}_gene_pairs.csv` file should contain:

```csv
gene1,gene2,Gene 1 Symbol,Gene 2 Symbol,Pearson (high),Pearson (low),Spearman (high),Spearman (low),Clustermatch (high),Clustermatch (low),ccc,pearson,spearman,ccc_pearson_diff,ccc_spearman_diff,ccc_combined_distance,ccc_mean_distance,ccc_max_distance
```

### Key Columns
- **gene1/gene2**: Ensembl gene IDs for the gene pair
- **Gene 1/2 Symbol**: Human-readable gene symbols
- **Correlation Values**: ccc, pearson, spearman correlation coefficients
- **Threshold Indicators**: Boolean flags for high/low thresholds
- **Distance Metrics**: Various correlation distance measures

## Output Files

### Per Combination Results
For each combination category, the tool generates:

- **Combined Pickle**: `combined_{combination}_top_gene_pairs.pkl`
- **Combined CSV**: `combined_{combination}_top_gene_pairs.csv`

### Output Structure
Each combined file contains:
- **tissue**: Added column indicating source tissue
- **All original columns**: From input CSV files
- **Combined data**: All tissues merged for the combination

### Summary Files
- **Summary Report**: `combination_summary_report.txt`
- **Log File**: `logs/gene_pair_combination_{timestamp}/gene_pair_combination.log`

### Example Output Files
```
combined_c-high-p-high-s-low_top_gene_pairs.pkl
combined_c-high-p-high-s-low_top_gene_pairs.csv
combined_c-high-p-low-s-high_top_gene_pairs.pkl  
combined_c-high-p-low-s-high_top_gene_pairs.csv
combined_c-high-p-low-s-low_top_gene_pairs.pkl
combined_c-high-p-low-s-low_top_gene_pairs.csv
combined_c-high-p-low-s-none_top_gene_pairs.pkl
combined_c-high-p-low-s-none_top_gene_pairs.csv
combined_c-high-p-none-s-low_top_gene_pairs.pkl
combined_c-high-p-none-s-low_top_gene_pairs.csv
```

## Analysis Workflow

### 1. **Discovery Phase**
- Scans data directory for available tissues
- Identifies all combination categories
- Maps file availability across tissue-combination pairs

### 2. **File Collection**
- Locates `top_{N}_gene_pairs.csv` files matching the specified pattern
- Reports missing files and coverage statistics
- Validates data integrity

### 3. **Combination Processing**
- For each combination category:
  - Loads CSV files from all available tissues
  - Adds tissue annotation column
  - Combines into unified dataframe
  - Saves results in multiple formats

### 4. **Summary Generation**
- Creates comprehensive statistics report
- Tracks processing success rates
- Documents output file locations
- Provides runtime performance metrics

## Performance Characteristics

### Expected Processing Time
- **Small datasets** (top 1000): ~10-30 seconds
- **Medium datasets** (top 10000): ~30-60 seconds
- **Large datasets** (top 50000+): ~2-5 minutes

### Memory Requirements
- **RAM**: ~2-8 GB depending on dataset size
- **Storage**: Combined files can be 100-500 MB per combination

### Processing Statistics (Example with --top 10000)
```
Combinations processed: 5
Total tissues processed: 270 (54 per combination)
Total gene pairs combined: 2,694,466
Unique genes per combination: 37,600-53,989
Runtime: ~27 seconds
```

## Data Validation

### File Discovery
- **Expected files**: 275 (55 tissues × 5 combinations)
- **Typical found**: 270-275 (some tissues may be missing certain combinations)
- **Missing file handling**: Logged as warnings, processing continues

### Data Integrity Checks
- **Row counting**: Verifies expected number of gene pairs per tissue
- **Column validation**: Ensures required columns are present
- **Duplicate detection**: Monitors for potential data overlap issues

## Example Workflows

### 1. Standard Processing
```bash
# Process the most common top-10000 dataset
python 10-correlate-top-genes-with-metadata.py --top 10000
```

### 2. Custom Analysis
```bash
# Process top 5000 with custom paths
python 10-correlate-top-genes-with-metadata.py \
    --top 5000 \
    --data-dir /custom/data/path \
    --output-dir /custom/output/path
```

### 3. Exploratory Analysis
```bash
# First explore what's available
python 10-correlate-top-genes-with-metadata.py --list-combinations
python 10-correlate-top-genes-with-metadata.py --list-tissues

# Then process smaller subset
python 10-correlate-top-genes-with-metadata.py --top 1000
```

## Troubleshooting

### Common Issues

1. **No matching files found**
   - Check if `top_{N}_gene_pairs.csv` files exist for specified N
   - Verify data directory path is correct
   - Ensure `report_top_gene_pairs.py` has been run first

2. **Missing files for some tissues**
   - Normal if some tissue-combination pairs weren't processed
   - Check warnings in log file for specific missing files
   - Processing continues with available files

3. **Memory errors**
   - Reduce the `--top` value to process smaller datasets
   - Ensure sufficient RAM is available
   - Monitor system resources during processing

4. **File format errors**
   - Verify input CSV files have expected column structure
   - Check for corrupted or incomplete input files
   - Review error messages in log file

### Error Messages

- **"Data directory not found"**: Verify `--data-dir` path exists
- **"No matching top gene pairs files found"**: Check if files exist for specified `--top` value
- **"Failed to load {tissue}"**: Individual tissue file corrupted or malformed

## Output Interpretation

### Combined DataFrames
- **Rows**: Gene pairs from all tissues for the combination
- **tissue column**: Indicates source tissue for each gene pair
- **Ranking**: Maintains original ranking within each tissue
- **Gene IDs**: Ensembl gene identifiers (gene1, gene2)
- **Gene Symbols**: Human-readable gene names
- **Correlation metrics**: CCC, Pearson, Spearman values
- **Threshold flags**: Boolean indicators for correlation thresholds

### Summary Statistics
- **Success Rate**: Percentage of successfully processed tissue files
- **Total Rows**: Combined gene pairs across all tissues
- **Unique Genes**: Number of distinct genes in the combination
- **Runtime**: Processing time for each combination

## Integration with Downstream Analysis

### Usage in Correlation Analysis
The combined files can be used as input for:
- **metadata_corr_cli.py**: Correlate top gene pairs with metadata
- **Gene set enrichment analysis**: Analyze biological pathways
- **Cross-tissue comparison**: Compare gene pair patterns across tissues
- **Network analysis**: Build gene co-expression networks

### Data Flow
```
report_top_gene_pairs.py → top_{N}_gene_pairs.csv files
                       ↓
10-correlate-top-genes-with-metadata.py → combined_{combination}_top_gene_pairs.csv
                                        ↓
                                   Downstream analysis tools
```

## File Size Considerations

### Typical File Sizes (--top 10000)
- **CSV files**: ~125-135 MB per combination
- **Pickle files**: ~55-65 MB per combination (compressed)
- **Total output**: ~1 GB for all combinations

### Storage Recommendations
- **Local processing**: Ensure 2-3 GB free space
- **Network storage**: Consider compression for long-term storage
- **Temporary space**: Additional 1 GB during processing

## Version Information

- **Script**: 10-correlate-top-genes-with-metadata.py
- **Purpose**: Combine top gene pairs across tissues and combinations
- **Input source**: report_top_gene_pairs.py results
- **Output format**: Tissue-annotated combined datasets

## Support

For issues related to:
- **Input files**: Check report_top_gene_pairs.py execution
- **Missing data**: Review tissue processing logs
- **Performance**: Monitor system resources and adjust --top value
- **File formats**: Verify CSV structure matches expected format 